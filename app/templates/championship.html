<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Championship Results - CC6 Race Series</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .filters { margin: 20px 0; display: flex; flex-direction: column; gap: 20px; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-group label { font-weight: bold; }
        select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>
    <img src="{{ url_for('static', filename='cc6-slogan-black.png') }}" alt="CC6 Logo" class="logo">
    
    {% include 'public_nav.html' %}
    
    <div class="container">
        <h1>Championship Results</h1>
        
        <div class="filters">
            <div class="filter-group">
                <label for="seasonSelect">Season:</label>
                <select id="seasonSelect">
                    <option value="">Select Season</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="genderSelect">Championship:</label>
                <select id="genderSelect">
                    <option value="Male">Men's Team Championship</option>
                    <option value="Female">Women's Team Championship</option>
                    <option value="Individual-Male">Men's Individual Championship</option>
                    <option value="Individual-Female">Women's Individual Championship</option>
                </select>
            </div>
        </div>
        
        <button id="loadChampionship" disabled>Load Championship</button>
    </div>
    
    <div id="championshipContainer" class="results-container" style="overflow-x: auto; width: calc(100vw - 40px); margin-left: calc(-50vw + 50% + 20px); text-align: center; padding: 0 20px;"></div>
    
    <script>
        let seasons = [];
        
        // Load seasons on page load
        async function loadSeasons() {
            try {
                const response = await fetch('/api/seasons');
                seasons = await response.json();
                
                const seasonSelect = document.getElementById('seasonSelect');
                seasonSelect.innerHTML = '<option value="">Select Season</option>';
                
                seasons.forEach(season => {
                    const option = document.createElement('option');
                    option.value = season;
                    option.textContent = season;
                    seasonSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading seasons:', error);
            }
        }
        
        // Load and display championship results
        async function loadChampionship() {
            const seasonId = document.getElementById('seasonSelect').value;
            const gender = document.getElementById('genderSelect').value;
            
            if (!seasonId || !gender) return;
            
            const container = document.getElementById('championshipContainer');
            container.innerHTML = '<div class="loading">Loading championship results...</div>';
            
            try {
                const isIndividual = gender.startsWith('Individual-');
                const actualGender = isIndividual ? gender.replace('Individual-', '') : gender;
                const endpoint = isIndividual ? `/api/individual-championship/${seasonId}/${actualGender}` : `/api/championship/${seasonId}/${gender}`;
                
                const response = await fetch(endpoint);
                const championshipData = await response.json();
                
                console.log('Championship data:', championshipData); // Debug log
                
                if (response.ok) {
                    displayChampionship(championshipData, gender);
                } else {
                    container.innerHTML = `<div class="error">Error: ${championshipData.error}</div>`;
                }
            } catch (error) {
                container.innerHTML = `<div class="error">Error loading championship: ${error.message}</div>`;
            }
        }
        
        // Display championship results
        function displayChampionship(data, gender) {
            const container = document.getElementById('championshipContainer');
            
            const isIndividual = gender.startsWith('Individual-');
            let html = `
                <div class="race-info">
                    <h2>${data.gender} Championship - ${data.season}</h2>
                    <p><strong>Scoring:</strong> ${isIndividual ? 'Best 3 race results per individual' : 'Top ' + (data.gender === 'Male' ? '4' : '3') + ' finishers per club per race'}</p>
                    <p><strong>Races included:</strong> ${data.races.length}</p>
                    ${!isIndividual ? '<p><i><strong>Note:</strong> Clubs may be marked as disqualified (DQ) due to having insufficient runners in a race.</i></p>' : ''}
                    ${!isIndividual ? '<p><i><strong>Note:</strong> The Total Rankings column will be adjusted if a club did not organise a race (for example due to cancellation).</i></p>' : ''}
                </div>
            `;
            
            if (data.standings.length > 0) {
                html += `
                    <table style="margin: 0 auto;">
                        <thead>
                            <tr>
                                <th>Position</th>
                                <th>${gender.startsWith('Individual-') ? 'Name' : 'Club'}</th>
                                <th>Total Rankings</th>
                `;
                
                // Add race columns
                data.races.forEach(race => {
                    html += `<th>${race.name}</th>`;
                });
                
                html += `
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                let currentPosition = 1;
                data.standings.forEach((entry, index) => {
                    const isIndividual = gender.startsWith('Individual-');
                    
                    // Handle joint positions for individual championships
                    if (isIndividual && index > 0 && entry.total_points !== data.standings[index - 1].total_points) {
                        currentPosition = index + 1;
                    } else if (!isIndividual) {
                        currentPosition = index + 1;
                    }
                    
                    html += `
                        <tr>
                            <td>${currentPosition}</td>
                            <td>${entry.name}${isIndividual && entry.club ? ' (' + entry.club + ')' : ''}</td>
                            <td><strong>${entry.total_points}</strong></td>
                    `;
                    
                    // Add race points
                    data.races.forEach(race => {
                        if (isIndividual) {
                            const position = entry.race_positions[race.name];
                            if (position) {
                                html += `<td>${position}</td>`;
                            } else {
                                html += `<td>-</td>`;
                            }
                        } else {
                            const raceData = entry.race_points[race.name];
                            if (raceData === 'ORG' || raceData === 'DQ') {
                                html += `<td>${raceData}</td>`;
                            } else if (raceData && raceData.rank) {
                                const positions = raceData.positions.join(', ');
                                html += `<td>${raceData.rank} (${positions} = ${raceData.points} points)</td>`;
                            } else {
                                html += `<td>-</td>`;
                            }
                        }
                    });
                    
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
            } else {
                html += '<p>No championship results found.</p>';
            }
            
            container.innerHTML = html;
        }
        
        // Event listeners
        document.getElementById('seasonSelect').addEventListener('change', function() {
            document.getElementById('loadChampionship').disabled = !this.value;
        });
        
        document.getElementById('loadChampionship').addEventListener('click', loadChampionship);
        
        // Load seasons on page load
        loadSeasons();
    </script>
</body>
</html>